{% extends '__layout.html' %}
{% import 'includes/_data_table.html' as table %}
{% import 'includes/_details_table.html' as details %}
{% import 'includes/_tabs.html' as tabs %}
{% import 'includes/_cards.html' as cards %}


{% block content %}
  <div class="row mb-4">
    <div class="col-sm-12 col-md-4">
      {% call cards.card() %}
        {{ details.render(reconstruction_view, reconstruction) }}
      {% endcall %}
    </div>
    <div class="col-sm-12 col-md-4">
      {% call cards.card('Trial') %}
        {{ details.render(trial_view, reconstruction.trial) }}
      {% endcall %}
    </div>
    <div class="col-sm-12 col-md-4">
      {% call cards.card('Experiment') %}
        {{ details.render(experiment_view, reconstruction.trial.experiment) }}
      {% endcall %}
    </div>
  </div>

  <div class="row">

    <ul class="nav nav-tabs" id="reconstruction-{{ reconstruction.id }}-tabs" role="tablist">
      {% if reconstruction.source == 'MF' %}
        {{ tabs.tab_item('Parameters', true) }}
        {{ tabs.tab_item('Stats') }}
      {% endif %}
      {{ tabs.tab_item('Tracking 2D') }}
      {{ tabs.tab_item('Tracking 3D', reconstruction.source != 'MF') }}
      {% if reconstruction.source == 'MF' %}
        {{ tabs.tab_item('Cameras') }}
        {{ tabs.tab_item('Point stats') }}
      {% endif %}
      {{ tabs.tab_item('Postures') }}
      {% if reconstruction.source == 'MF' %}
        {{ tabs.tab_item('Lengths') }}
      {% endif %}
      {{ tabs.tab_item('Eigenworms') }}
    </ul>

    <div class="frame-controls my-2" style="display: none;">
      <div class="d-flex justify-content-center align-items-center">
        <button type="button" class="fc-prev btn btn-primary btn-large">
          <span class="oi oi-arrow-thick-left"></span>
        </button>
        <div class="fc-progress progress mx-2">
          <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0"
               aria-valuemax="100"></div>
        </div>
        <button type="button" class="fc-next btn btn-primary btn-large">
          <span class="oi oi-arrow-thick-right"></span>
        </button>
        <div class="fc-time ms-3">
          <span class="fc-current-frame">{{ '{:,}'.format(reconstruction.start_frame) }}</span>
          / <span class="fc-num-frames">{{ '{:,}'.format(reconstruction.end_frame) }}</span>
        </div>
      </div>
    </div>

    <div class="tab-content" id="reconstruction-{{ reconstruction.id }}-panels">
      {% if reconstruction.source == 'MF' %}
        {% call tabs.tab_panel('Parameters', true) %}
          {{ details.render(parameters_view, reconstruction.mf_parameters) }}
        {% endcall %}

        {% call tabs.tab_panel('Stats') %}
          <div class="g-0 mt-1 mb-5 stats-plots">
            {% include 'includes/_loader.html' %}

            <div class="form-floating form-group">
              <select name="stat-key" id="stat-key-select" class="form-control form-select" placeholder="Statistic">
                {% for stat_key in stat_keys %}
                  <option value="{{ stat_key }}">{{ stat_key }}</option>
                {% endfor %}
              </select>
              <label for="stat-key-select">Statistic</label>
            </div>

            <div id="stats-plot"></div>
          </div>
        {% endcall %}
      {% endif %}

      {% call tabs.tab_panel('Tracking 2D') %}
        {% include 'includes/_tracking_plots_2d.html' %}
      {% endcall %}

      {% call tabs.tab_panel('Tracking 3D', reconstruction.source != 'MF') %}
        {% include 'includes/_tracking_plots_3d.html' %}
      {% endcall %}

      {% if reconstruction.source == 'MF' %}
        {% call tabs.tab_panel('Cameras') %}
          <div class="g-0 mt-1 mb-5 cameras-plots">
            {% include 'includes/_loader.html' %}
            <div class="form-floating form-group">
              <select name="cameras-key" id="cameras-key-select" class="form-control form-select"
                      placeholder="Camera parameters">
                {% for cam_key in cam_keys %}
                  <option value="{{ cam_key }}">{{ cam_key }}</option>
                {% endfor %}
              </select>
              <label for="cameras-key-select">Camera parameters</label>
            </div>
            <div id="cameras-plots"></div>
          </div>
        {% endcall %}

        {% call tabs.tab_panel('Point stats') %}
          <div class="g-0 mt-1 mb-5 point-stats-plots">
            {% include 'includes/_loader.html' %}
            <div class="row g-1">
              <div id="sigmas-plots" class="col"></div>
              <div id="intensities-plots" class="col"></div>
              <div id="scores-plots" class="col"></div>
            </div>
          </div>
        {% endcall %}
      {% endif %}

      {% call tabs.tab_panel('Postures') %}
        <div class="g-0 mt-1 mb-5 postures-plots">
          {% include 'includes/_loader.html' %}

          <div class="row g-1 flex">
            <div class="col col-md-8 flex vh-100">
              {% if reconstruction.source == 'MF' %}
              <div class="form-floating form-group">
                <select name="depth" id="depth-select" class="form-control form-select"
                        placeholder="Depth">
                  {% for d in range(reconstruction.mf_parameters.depth) %}
                    {% set selected = ' selected' if loop.last else '' %}
                    <option value="{{ d }}"{{ selected }}>{{ d }}</option>
                  {% endfor %}
                </select>
                <label for="depth-select">Depth</label>
              </div>
              {% endif %}
              <div id="posture-3d-plot" class="h-100"></div>
            </div>

            <div id="posture-2d-images" class="col col-md-{{ '2' if reconstruction.source == 'MF' else '4' }} vh-100">
              <div class="d-flex flex-column align-items-center h-100"></div>
            </div>
            {% if reconstruction.source == 'MF' %}
              <div id="posture-2d-masks" class="col col-md-2 vh-100">
                <div class="d-flex flex-column align-items-center h-100"></div>
              </div>
            {% endif %}
          </div>
        </div>
      {% endcall %}

      {% if reconstruction.source == 'MF' %}
        {% call tabs.tab_panel('Lengths') %}
          <div class="g-0 mt-1 mb-5 length-plots">
            {% include 'includes/_loader.html' %}
            <div id="length-plots"></div>
          </div>
        {% endcall %}
      {% endif %}

      {% call tabs.tab_panel('Eigenworms') %}
        <div class="g-0 mt-1 mb-5 eigenworms-plots">
          {% include 'includes/_loader.html' %}
          <div class="form-floating form-group">
            <select name="eigenworms-select" id="eigenworms-select" class="form-control form-select"
                    placeholder="Eigenworms">
              {% for ew in reconstruction.eigenworms %}
                {% set selected = ' selected' if loop.first else '' %}
                <option value="{{ ew.id }}"{{ selected }}>{{ ew }}</option>
              {% endfor %}
            </select>
            <label for="eigenworms-select">Eigenworms</label>
          </div>

          <div class="row">
            <div class="col col-md-4">
{#              {% call cards.card() %}#}
{#                {{ details.render(eigenworms_view, reconstruction) }}#}
{#              {% endcall %}#}
            </div>

            <div class="col col-md-4">
              <div id="ew-eigenvalues-plot"></div>
            </div>
            <div class="col col-md-4">
              <div id="ew-variance-plot"></div>
            </div>

          </div>

        </div>
      {% endcall %}

    </div>

  </div>

{% endblock %}


{% block scripts %}
  <script>
      $(document).ready(function () {
          {% if reconstruction.source == 'MF' %}
          // ========================== Stats ==========================
          let stats = {};
          let stats_plot_data = [{
              x: [],
              y: [],
              type: 'line',
          }];
          let stats_plot_layout = {
              xaxis: {
                  title: 'Time (s)',
                  type: 'date',
                  tickformat: '%M:%S'
              }
          };
          Plotly.newPlot('stats-plot', stats_plot_data, stats_plot_layout, plot_config);

          function get_stats(key) {
              $('#stats-panel .loader').show();
              $.getJSON('{{ url_for('api.get_stats', _id=reconstruction.id) }}', {key: key}, function (data) {
                  stats[key] = {
                      x: timestamps_to_dates(data['timestamps']),
                      y: data['values']
                  }
                  $('#stats-panel .loader').hide();
                  plot_stats(key);
              });
          }

          function plot_stats(k) {
              stats_plot_data[0]['x'] = stats[k]['x'];
              stats_plot_data[0]['y'] = stats[k]['y'];
              Plotly.redraw('stats-plot');
          }

          $('#stat-key-select').change(function () {
              let k = $(this).val();
              if (k in stats) {
                  plot_stats(k);
              } else {
                  get_stats(k);
              }
          });

          // Load stats data and draw plot when the tab is activated
          $('#stats-tab').one('shown.bs.tab', function () {
              $('#stat-key-select').change();
          });

          {% endif %}

          // ========================== Tracking trajectories ==========================
          let X, ts;

          function get_trajectory(cb) {
              $.getJSON('{{ url_for('api.get_trajectory_data', _id=reconstruction.id) }}', function (data) {
                  ts = data['timestamps'];
                  X = data['X'];
                  cb();
              });
          }

          // Load tracking data and draw 2d plots when the tab is activated
          $('#tracking-2d-tab').one('shown.bs.tab', function () {
              function make_plots() {
                  $('#tracking-2d-panel .loader').hide();
                  plot_tracking_pairs(X, 0, 1, ts);
                  plot_tracking_pairs(X, 0, 2, ts);
                  plot_tracking_pairs(X, 1, 2, ts);
                  for (let i = 0; i < 3; i++) {
                      plot_tracking_single(X, i, ts);
                  }
              }

              if (X) {
                  make_plots()
              } else {
                  get_trajectory(make_plots)
              }
          });

          // Load tracking data and draw 3d plot when the tab is activated
          $('#tracking-3d-tab').one('shown.bs.tab', function () {
              function make_plots() {
                  $('#tracking-3d-panel .loader').hide();
                  plot_tracking_3d(X, ts);
              }

              if (X) {
                  make_plots()
              } else {
                  get_trajectory(make_plots)
              }
          });

          {% if reconstruction.source != 'MF' %}
              $('#tracking-3d-tab').trigger('shown.bs.tab');
          {% endif %}


          {% if reconstruction.source == 'MF' %}
          // ========================== Cameras ==========================
          let cameras_params = {};

          function make_cameras_plot(timestamps, data, title) {
              let plot_data = [{
                  x: timestamps,
                  y: data[0],
                  type: 'line',
                  name: 'Camera 0'
              }, {
                  x: timestamps,
                  y: data[1],
                  type: 'line',
                  name: 'Camera 1'
              }, {
                  x: timestamps,
                  y: data[2],
                  type: 'line',
                  name: 'Camera 2'
              }];
              let layout = {
                  title: title,
                  xaxis: {
                      title: 'Time (s)',
                      type: 'date',
                      tickformat: '%M:%S'
                  }
              };
              $('#cameras-plots').append('<div class="row"></div>')
              Plotly.newPlot($('#cameras-plots div:last')[0], plot_data, layout, plot_config);
          }

          function get_cameras_params(key) {
              $('#cameras-panel .loader').show();
              $.getJSON('{{ url_for('api.get_cameras_parameters', _id=reconstruction.id) }}', {key: key}, function (data) {
                  cameras_params[key] = data;
                  $('#cameras-panel .loader').hide();
                  plot_cameras_params(key);
              });
          }

          function plot_cameras_params(k) {
              let p = cameras_params[k];
              let tms = timestamps_to_dates(p['timestamps']);
              $('#cameras-plots div').each(function () {
                  Plotly.purge(this);
              });
              for (let i = 0; i < p['shape'][0]; i++) {
                  make_cameras_plot(tms, p['data'][i], p['titles'][i])
              }
          }

          $('#cameras-key-select').change(function () {
              let k = $(this).val();
              if (k in cameras_params) {
                  plot_cameras_params(k);
              } else {
                  get_cameras_params(k);
              }
          });

          // Load camera params and draw plot when the tab is activated
          $('#cameras-tab').one('shown.bs.tab', function () {
              $('#cameras-key-select').change();
          });


          // ========================== Points stats (sigmas, intensities, scores) ==========================

          let ps_keys = ['sigmas', 'intensities', 'scores'];
          let ps_data = {};
          let ps_plot_data = {'sigmas': [], 'intensities': [], 'scores': []};
          let ps_layouts = {};
          for (let i = 0; i < 3; i++) {
              let k = ps_keys[i];
              for (let d = 0; d < {{ reconstruction.mf_parameters.depth }}; d++) {
                  ps_plot_data[k].push({
                      x: [],
                      y: [],
                      type: 'line',
                      name: 'Depth ' + String(d)
                  });
              }

              ps_layouts[k] = {
                  title: k.charAt(0).toUpperCase() + k.slice(1),
                  xaxis: {title: 'Body coordinate',},
                  margin: {t: 50},
              };

              Plotly.newPlot(k + '-plots', ps_plot_data[k], ps_layouts[k], plot_config);
          }

          function plot_point_stats() {
              let xs = ps_data[frame_num]['xs'];
              for (let i = 0; i < 3; i++) {
                  let k = ps_keys[i];
                  let p = ps_data[frame_num][k];
                  for (let d = 0; d < {{ reconstruction.mf_parameters.depth }}; d++) {
                      ps_plot_data[k][d]['x'] = xs[d];
                      ps_plot_data[k][d]['y'] = p[d];
                  }
                  Plotly.react(k + '-plots', ps_plot_data[k], ps_layouts[k], plot_config);
              }
          }

          function get_point_stats() {
              $('#point-stats-panel .loader').show();
              $.getJSON('{{ url_for('api.get_point_stats', _id=reconstruction.id) }}', {frame_num: frame_num}, function (data) {
                  ps_data[frame_num] = data;
                  $('#point-stats-panel .loader').hide();
                  plot_point_stats();
              });
          }

          function update_point_stats_plots() {
              if (frame_num in ps_data) {
                  plot_point_stats();
              } else {
                  get_point_stats();
              }
          }

          // Load sigmas and draw plot when the tab is activated
          $('#point-stats-tab').one('shown.bs.tab', function () {
              update_point_stats_plots();
          });

          {% endif %}

          // ========================== Postures ==========================
          let depth = $('#depth-select').val();

          let postures_data = {
          {% if reconstruction.source == 'MF' %}
            {% for d in range(reconstruction.mf_parameters.depth) %}
                {{ d }}: {},
            {% endfor %}
          {% else %}
              undefined: {}
          {% endif %}
          };

          let postures_3d_plot_data = [{
              x: [],
              y: [],
              z: [],
              type: 'scatter3d',
              mode: 'markers',
              marker: {
                  size: 2,
                  colorscale: 'Jet'
              }
          }];
          let postures_3d_plot_layout = {
              scene: {
                  aspectmode: 'data',
              },
              margin: {
                  t: 50
              },
              xaxis: {
                  title: 'x',
              },
              yaxis: {
                  title: 'y'
              },
              zaxis: {
                  title: 'z'
              }
          };
          Plotly.newPlot('posture-3d-plot', postures_3d_plot_data, postures_3d_plot_layout, plot_config);

          function plot_posture_3d() {
              let data = postures_data[depth][frame_num].posture;
              postures_3d_plot_data[0].x = data[0];
              postures_3d_plot_data[0].y = data[1];
              postures_3d_plot_data[0].z = data[2];
              postures_3d_plot_data[0].marker.color = linspace(0, 1, data[0].length);
              Plotly.react('posture-3d-plot', postures_3d_plot_data);
          }

          function draw_posture_2d_images() {
              let images = postures_data[depth][frame_num].images;
              let imgs = '';
              for (let i = 0; i < images.length; i++) {
                  imgs += '<img src="' + images[i] + '" class="mt-1 mw-100 vh-100"/>'; // w-100
              }
              $('#posture-2d-images .flex-column').html(imgs);
          }

          function draw_posture_2d_masks() {
              let masks = postures_data[depth][frame_num].masks;
              let imgs = '';
              for (let i = 0; i < masks.length; i++) {
                  imgs += '<img src="' + masks[i] + '" class="mt-1 mw-100 vh-100"/>';
              }
              $('#posture-2d-masks .flex-column').html(imgs);
          }

          function get_posture() {
              $('#postures-panel .loader').show();
              $.getJSON('{{ url_for('api.get_posture', _id=reconstruction.id) }}', {
                  frame_num: frame_num,
                  depth: depth
              }, function (data) {
                  postures_data[depth][frame_num] = data;
                  $('#postures-panel .loader').hide();
                  draw_posture_2d_images();
                  {% if reconstruction.source == 'MF' %}
                    draw_posture_2d_masks();
                  {% endif %}
                  plot_posture_3d();
              });
          }

          function update_postures() {
              if (frame_num in postures_data[depth]) {
                  plot_posture_3d();
                  draw_posture_2d_images();
                  {% if reconstruction.source == 'MF' %}
                      draw_posture_2d_masks();
                  {% endif %}
              } else {
                  get_posture();
              }
          }

          $('#depth-select').change(function () {
              depth = $(this).val();
              update_postures();
          });

          // Load sigmas and draw plot when the tab is activated
          $('#postures-tab').one('shown.bs.tab', function () {
              update_postures();
          });

          // ========================== Frame controls ==========================
          let frame_num = {{ reconstruction.start_frame }};

          function set_frame_num(new_frame_num) {
              frame_num = new_frame_num;
              let progress = (frame_num -{{ reconstruction.start_frame }}) / {{ reconstruction.n_frames }};
              $('.fc-current-frame').text(Number(frame_num).toLocaleString());
              $('.fc-progress .progress-bar').width((progress * 100) + '%');
              {% if reconstruction.source == 'MF' %}
              update_point_stats_plots();
              {% endif %}
              update_postures();
          }

          $('.fc-prev').click(function () {
              if (frame_num > 0) {
                  set_frame_num(frame_num - 1);
              }
          });

          $('.fc-next').click(function () {
              if (frame_num < {{ reconstruction.end_frame }}) {
                  set_frame_num(frame_num + 1);
              }
          });

          $('.fc-progress').on('mousedown', function (e) {
              e.preventDefault();
              let progress = (e.pageX - $(this).offset().left) / $(this).width();
              let new_frame_num = Math.round({{ reconstruction.start_frame }} +progress * {{ reconstruction.n_frames }});
              set_frame_num(new_frame_num);
          });

          // Show frame controls when the relevant tabs are activated
          $('#point-stats-tab, #postures-tab').on('shown.bs.tab', function () {
              $('.frame-controls').show();
          });

          // Hide frame controls when not needed
          $('#point-stats-tab, #postures-tab').on('hidden.bs.tab', function () {
              $('.frame-controls').hide();
          });


          {% if reconstruction.source == 'MF' %}
          // ========================== Lengths ==========================
          let lengths_plot_data = [];
          for (let d = 1; d < {{ reconstruction.mf_parameters.depth }}; d++) {
              lengths_plot_data.push({
                  x: [],
                  y: [],
                  type: 'line',
                  name: 'Depth ' + String(d)
              });
          }

          let lengths_layout = {
              title: 'Worm length',
              xaxis: {title: 'Time (s)', type: 'date', tickformat: '%M:%S'},
              yaxis: {title: 'Length (mm)',},
              margin: {t: 50},
          };

          Plotly.newPlot('length-plots', lengths_plot_data, lengths_layout, plot_config);

          function get_lengths() {
              $('#lengths-panel .loader').show();
              $.getJSON('{{ url_for('api.get_worm_lengths', _id=reconstruction.id) }}', {frame_num: frame_num}, function (data) {
                  for (let d = 0; d < {{ reconstruction.mf_parameters.depth }} -1; d++) {
                      lengths_plot_data[d]['x'] = timestamps_to_dates(data['timestamps']);
                      lengths_plot_data[d]['y'] = data['lengths'][d + 1];
                  }
                  Plotly.react('length-plots', lengths_plot_data, lengths_layout, plot_config);
                  $('#lengths-panel .loader').hide();
              });
          }

          // Load lengths and draw plot when the tab is activated
          $('#lengths-tab').one('shown.bs.tab', function () {
              get_lengths();
          });

          {% endif %}


          // ========================== Eigenworms ==========================
          let eigenworms = {};

          let ew_eigenvalues_plot_data = [{
              x: [],
              y: [],
              type: 'line',
          }];
          let ew_eigenvalues_plot_layout = {
              title: 'Eigenvalues',
              xaxis: {
                  title: 'Component',
              }
          };
          Plotly.newPlot('ew-eigenvalues-plot', ew_eigenvalues_plot_data, ew_eigenvalues_plot_layout, plot_config);

          let ew_variance_plot_data = [{
              x: [],
              y: [],
              type: 'line',
          }];
          let ew_variance_plot_layout = {
              title: 'Cumulative Variance',
              xaxis: {
                  title: 'Component',
              }
          };
          Plotly.newPlot('ew-variance-plot', ew_variance_plot_data, ew_variance_plot_layout, plot_config);

          function get_eigenworms(ewid) {
              $('#eigenworms-panel .loader').show();
              $.getJSON('/api/eigenworms/' + ewid, function (data) {
                  eigenworms[ewid] = {
                      x: data['idxs'],
                      eigenvalues: data['singular_values'],
                      variance: data['explained_variance_ratio']
                  }
                  $('#eigenworms-panel .loader').hide();
                  plot_eigenworms(ewid);
              });
          }

          function plot_eigenworms(ewid) {
              ew_eigenvalues_plot_data[0]['x'] = eigenworms[ewid]['x'];
              ew_eigenvalues_plot_data[0]['y'] = eigenworms[ewid]['eigenvalues'];
              Plotly.react('ew-eigenvalues-plot', ew_eigenvalues_plot_data, ew_eigenvalues_plot_layout);
              ew_variance_plot_data[0]['x'] = eigenworms[ewid]['x'];
              ew_variance_plot_data[0]['y'] = eigenworms[ewid]['variance'];
              Plotly.react('ew-variance-plot', ew_variance_plot_data, ew_variance_plot_layout);
          }

          $('#eigenworms-select').change(function () {
              let ewid = $(this).val();
              if (ewid in eigenworms) {
                  plot_eigenworms(ewid);
              } else {
                  get_eigenworms(ewid);
              }
          });

          // Load eigenworms and draw plots when the tab is activated
          $('#eigenworms-tab').one('shown.bs.tab', function () {
              $('#eigenworms-select').change();
          });
      });
  </script>

{% endblock %}

